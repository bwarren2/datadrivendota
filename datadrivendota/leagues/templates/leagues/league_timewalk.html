{% extends "row_base.html" %}

{% load staticfiles player_extras %}
{% block title %}
    {{league.display_name}}
{% endblock title %}
{% block page_title %}
    {{league.display_name}}
{% endblock page_title %}
{% block content %}

  <nav>
    <ul class="nav nav-pills">
      <li role="presentation"><a href="#">Overview</a></li>
      <li role="presentation" class="active"><a href="{% url 'leagues:detail-timewalk' steam_id=league.steam_id %}">Time Walk <i class="fa fa-clock-o"></i></a></li>
    </ul>
  </nav>

  <div class='row'>
    <div class='col-md-4'>
        <h4>Hero Picks &amp; Bans</h4>
        <div id='pickban_chart'></div>
    </div>
    <div class='col-md-4'>
        <h4>Hero Winrate</h4>
        <div id='winrate_chart'></div>
    </div>
    <div class='col-md-8'>
        <h4>Relative Strength</h4>
        <div id='strength_barchart'></div>
    </div>
  </div>


{% endblock content %}


{% block extra_js %}
<script type="text/javascript">
$(function(){

  window.comboBox();
  $('#combo-select').select2({
    ajax: {
      delay: 250,
      url:'/matches/api/combobox_tags/',
      processResults: function (data) {
        var res = data.results.map(function (elt) {
         return {id: elt.label, text: elt.value}; }
        )
        return {results: res};
      },
    },
    minimumInputLength: 3,
  });

  Promise.resolve(
    $.ajax(
      "/rest-api/matches/?" + $.param(
        {league_id:{{league.steam_id}}, page_size:300}
      )
    )
  ).then(function(data){
    winrate_data = data;
    var idx = 0;
    var update = function(tick){
      idx = (idx + tick).mod(winrate_data.length);
      $(window).trigger('update', idx);
    }

      // Set up timing controls
      var timer;
      function runner() {
        update(1);
        timer = setTimeout(runner, 1000);
      }
      $(window).on('play', function(){
        console.log('Playing');
        runner();
      });
      $(window).on('pause', function(){
         console.log('Stopping');
         clearTimeout(timer);
      });
      $(window).on('forward', function(){
        update(1);
      });
      $(window).on('back', function(){
        update(-1);
      });
      $(window).on('update', function (evt, position_array) {
        var width = (position_array.length / winrate_data.length) * 100;
        $('#progress-bar').css('width', '' + width + '%');
        $('#progress-bar').attr('aria-valuenow', width);
        // Update progress bar time.
        // @TODO make this show time, not ticks?
        $('#progress-bar-current').html(position_array.length);
      });

    d7.extensions.charts.heroes.pickban_scatter(
      '#pickban_chart', {league_id:{{league.steam_id}}, page_size:300}
    );
    d7.extensions.charts.heroes.winrate_scatter(
      '#winrate_chart', {league_id:{{league.steam_id}}, page_size:300}
    );
    d7.extensions.charts.heroes.quality_barchart(
      '#strength_barchart', {league_id:{{league.steam_id}}, page_size:100}
    );

  })
})
</script>
{% endblock extra_js %}

{% block extra_css %}

<style type="text/css">

.tip {
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(100, 100, 100, 0.8);
  color: #fff;
  border-radius: 2px;
}

/* Creates a small triangle extender for the tooltip */
.tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 10px;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
}

circle:hover {
  fill: #F700FF;
}

/* Style northward tooltips differently */
/*.tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}
*/
</style>
{% endblock extra_css %}
