{% extends "payments/pay_base.html" %}
{% load url from future %}

{% block title %}Purchase a Subscription{% endblock title %}

{% block content %}
    {% with request.user.customer.current_subscription as subscription %}
        {% if not subscription or subscription.status != 'active'  %}
            {% include "payments/_subscription_status.html" %}
            {% include "payments/_subscribe_form.html" %}
        {% else %}
            <h2>Purchase a Subscription</h2>
            <p class="lead">You currently already have an active subscription, which will automatically renew in <strong>{{ subscription.current_period_end|timeuntil }}</strong>. If you like, you can view your <a href="{% url 'payments:payments_history' %}">payment history</a>, <a href="{% url 'payments:payments_change_card' %}">change your card</a> or <a href="{% url 'payments:payments_change_plan' %}">change your subscription</a>.</p>
        {% endif %}
    {% endwith %}
{% endblock %}

{% block extra_js %}
	<script src="//checkout.stripe.com/v2/checkout.js"></script>
<script>
    $(function() {
        $('body').on("click", '.change-card, .subscribe-form button[type=submit]', function(e) {
          e.preventDefault();
          var $form = $(this).closest("form"),
              token = function(res) {
                $form.find("input[name=stripe_token]").val(res.id);
                $form.trigger("submit");
              };

          StripeCheckout.open({
            key:         $form.data("stripe-key"),
            name:        'Payment Method',
            panelLabel:  'Add Payment Method',
            token:       token
          });

          return false;
        });
    });
</script>
{% endblock extra_js %}