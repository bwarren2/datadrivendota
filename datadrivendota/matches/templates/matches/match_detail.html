{% extends "base.html" %}

{% load staticfiles player_extras %}

{% block extra_css %}{{ form.media }}{% endblock extra_css %}

{% block title %}Match #{{ match.steam_id }}{% endblock title %}

{% block page_title %}
    {% include "matches/_match_header_card.html" %}
{% endblock page_title %}

{% block content %}


  <div class="row">
    <div id='level-row' class="charts col-md-6">
    <h4>Level Progression</h4>
          <div id='abilities'></div>
    </div>

    <div id='matchup-charts' class='col-md-6'>
      <div class='row'>
        <div id='kill_dmg' class="charts col-md-6">
          <h4>Kills vs Damage</h4>
        </div>
        <div id='xp_gold' class="charts col-md-6">
          <h4>Gold vs EXP</h4>
        </div>
        <div id='kill_death' class="charts col-md-6">
          <h4>Kills vs Deaths</h4>
        </div>
        <div id='lh_denies' class="charts col-md-6">
          <h4>Last Hits vs Denies</h4>
        </div>

      </div>
  </div>

  <div class="row">
    </div>

    <div class="charts col-md-4">
    <h4>Pushing Damage</h4>
        <div id='tower_damage'></div>
    </div>

    <div class="charts col-md-4">
    <h4>Last Hits</h4>
        <div id='last_hits'></div>
    </div>

    <div class="charts col-md-4">
    <h4>KDA2</h4>
        <div id='kda2'></div>
    </div>
  </div>

  {% if dire_bans or radiant_bans %}
    <h4 id='pickban-tool'>Picks and Bans</h4>
    <div class="row controls-button">
      <div class="col-sm-12 text-center">
        <div>
          Pick/ban
        </div>
        <div class="btn-group">
          <button class="btn btn-default" id="pickban-backward"><i class="glyphicon glyphicon-backward"></i></button>
          <button class="btn btn-default disabled" id="pickban-reveal">Pick/Ban</button>
          <button class="btn btn-default" id="pickban-forward"><i class="glyphicon glyphicon-forward"></i></button>
        </div>
      </div>
    </div>

    <div class="row">

      <div class="radiant-pickban col-md-6">
        <h3>Radiant</h3>
        <div class="row">
          <div class="col-md-3">
            <h4>Ban</h4>
            <ul class="pickban-list" id="dire-ban">
              {% for pb in radiant_bans %}
                <li data-pborder="{{ pb.order }}">
                  {% if pb.hero.mugshot %}
                  <a href="#" class="thumbnail">
                    <img src="{{ pb.hero.thumbshot.url }}" alt="{{ pb.hero.name }}" title="{{ pb.hero.name }}">
                  </a>
                  {% else %}
                  {{ pb.hero.name }}
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          </div>
          <div class="col-md-9">
            <h4>Pick</h4>
            <ul class="pickban-list" id="dire-pick">
              {% for pb in radiant_picks %}
                <li data-pborder="{{ pb.order }}">
                  {% if pb.hero.mugshot %}
                    <a href="#" class="thumbnail">
                      <img src="{{ pb.hero.mugshot.url }}" alt="{{ pb.hero.name }}" title="{{ pb.hero.name }}">
                    </a>
                  {% else %}
                  {{ pb.hero.name }}
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>

      <div class="dire-pickban col-md-6">
        <h3>Dire</h3>
        <div class="row">
          <div class="col-md-3">
            <h4>Ban</h4>
            <ul class="pickban-list" id="dire-ban">
              {% for pb in dire_bans %}
                <li data-pborder="{{ pb.order }}">
                  <a href="#" class="thumbnail">
                    <img src="{{ pb.hero.thumbshot.url }}" alt="{{ pb.hero.name }}" title="{{ pb.hero.name }}">
                  </a>
                </li>
              {% endfor %}
            </ul>
          </div>
          <div class="col-md-9">
            <h4>Pick</h4>
            <ul class="pickban-list" id="dire-pick">
              {% for pb in dire_picks %}
                <li data-pborder="{{ pb.order }}">
                  <a href="#" class="thumbnail">
                    <img src="{{ pb.hero.mugshot.url }}" alt="{{ pb.hero.name }}" title="{{ pb.hero.name }}">
                  </a>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>

    </div>

  {% endif %}

  <h4>Abilities</h4>
  <div class="row controls-button">
    <div class="col-sm-12 text-center">
      <button class="btn btn-default" id="abilities-reveal">Show/Hide abilities</button>
    </div>
  </div>

  <div class="row" id='abilities'>
    <div class='col-md-12'>
      <div class='radiant-abilities'>
      <h5>Radiant</h5>
        {% for key, summary in radiant_infodict.items %}
          <div class='ability-row'>

            {% if summary.hero_thumbshot %}
              <span class='ability-row-hero'>
                <img src="{{ summary.hero_thumbshot_url }}" alt="{{ summary.hero_name }}" title="{{ summary.hero_name }}" style='height:35px'>
              </span>
            {% else %}
              <span class='ability-row-hero'></span>
            {% endif %}

            {% if summary.ability_dict %}
              {% for ability in summary.ability_dict %}
                <a href="{%url 'heroes:ability_detail' ability_name=ability.machine_name%}">
                    <img class='ability-thumbshot' src="{{ability.picture_url}}" title="{{ability.name}}" >
                </a>
              {% endfor %}
            {% else %}
                <text>Not given :(</text>
            {% endif %}
          </div>
        {% endfor %}
      </div>
      <div class='dire-abilities'>
      <h5>Dire</h5>
        {% for key, summary in dire_infodict.items %}

          <div class='ability-row'>
            {% if summary.hero_thumbshot %}
              <span class='ability-row-hero'>
                <img src="{{ summary.hero_thumbshot_url }}" alt="{{ summary.hero_name }}" title="{{ summary.hero_name }}" style='height:35px'>
              </span>
              {% else %}
              <span class='ability-row-hero'>
              </span>
            {% endif %}
          {% if summary.ability_dict %}
            {% for ability in summary.ability_dict %}
            <a href="{%url 'heroes:ability_detail' ability_name=ability.machine_name%}">
                <img class='ability-thumbshot' src="{{ability.picture_url}}" title="{{ability.name}}">
              </a>
            {% endfor %}
          {% else %}
              <text>Not given :(</text>
          {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>


  <div class="row">
    <div class='col-md-12'>
      <h4>Endgame Table</h4>
      <table class="table  table-condensed" id='myTable'>
        <thead>
          <tr>
            <th>Hero</th>
            <th colspan="2">Player</th>
            <th title='Kills'>K</th>
            <th title='Deaths'>D</th>
            <th title='Assists'>A</th>
            <th title='Kills - Deaths + Assists/2'>KDA2</th>
            <th title='Items'>Items</th>
            <th title='Level'>Lvl</th>
            <th title='Last Hits'>LH</th>
            <th title='Denies'>DN</th>
            <th title='Gold per minute'>GPM</th>
            <th title='Experience per minute'>XPM</th>
            <th title='Damage to heroes'>H Dmg</th>
            <th title='Damage to Towers'>T Dmg</th>
            <th title='Heal to heroes'>Hero Heal</th>
            <th title='Which side did they play for?'>Side</th>
            <th title='Did they win?'>Win?</th>
          </tr>
        </thead>
        <tbody>
          {% for summary in summaries %}
            <tr>
              {% if summary.hero.thumbshot %}
                <td><img src="{{ summary.hero.thumbshot.url }}" alt="{{ summary.hero.name }}" title="{{ summary.hero.name }}" class="summary-hero-thumbshot"></td>
              {% else %}
                <td></td>
              {% endif %}

              <td>{% player_link summary.player %}</td>
              <td><img src="{{ summary.player.avatar }}" class="summary-hero-thumbshot"></td>
              <td>{{ summary.kills }}</td>
              <td>{{ summary.deaths }}</td>
              <td>{{ summary.assists }}</td>
              <td>{{ summary.kda2 }}</td>

              <td class="match-summary-images">
                {% if summary.item_0.mugshot %}
                <a href="{%url 'items:detail' item_name=summary.item_0.slug_name%}">
                  <img src="{{ summary.item_0.thumbshot.url }}"
                  alt="{{ summary.item_0.name }}"
                  title="{{ summary.item_0.name }}"
                  ></a>
                {% endif %}
                {% if summary.item_1.thumbshot %}
                <a href="{%url 'items:detail' item_name=summary.item_1.slug_name%}">
                  <img src="{{ summary.item_1.thumbshot.url }}"
                  alt="{{ summary.item_1.name }}"
                  title="{{ summary.item_1.name }}"
                  ></a>
                {% endif %}
                {% if summary.item_2.thumbshot %}
                <a href="{%url 'items:detail' item_name=summary.item_2.slug_name%}">
                  <img src="{{ summary.item_2.thumbshot.url }}"
                  alt="{{ summary.item_2.name }}"
                  title="{{ summary.item_2.name }}"
                  ></a>
                {% endif %}
                {% if summary.item_3.thumbshot %}
                <a href="{%url 'items:detail' item_name=summary.item_3.slug_name%}">
                  <img src="{{ summary.item_3.thumbshot.url }}"
                  alt="{{ summary.item_3.name }}"
                  title="{{ summary.item_3.name }}"
                  ></a>
                {% endif %}
                {% if summary.item_4.thumbshot %}
                <a href="{%url 'items:detail' item_name=summary.item_4.slug_name%}">
                  <img src="{{ summary.item_4.thumbshot.url }}"
                  alt="{{ summary.item_4.name }}"
                  title="{{ summary.item_4.name }}"
                  ></a>
                {% endif %}
                {% if summary.item_5.thumbshot %}
                <a href="{%url 'items:detail' item_name=summary.item_5.slug_name%}">
                  <img src="{{ summary.item_5.thumbshot.url }}"
                  alt="{{ summary.item_5.name }}"
                  title="{{ summary.item_5.name }}"
                  ></a>
                {% endif %}

              </td>

              <td>{{ summary.level }}</td>
              <td>{{ summary.last_hits }}</td>
              <td>{{ summary.denies }}</td>
              <td>{{ summary.gold_per_min }}</td>
              <td>{{ summary.xp_per_min }}</td>
              <td>{{ summary.hero_damage }}</td>
              <td>{{ summary.tower_damage }}</td>
              <td>{{ summary.hero_healing }}</td>
              <td class="match-summary-images">
                {% if summary.is_radiant %}
                  <img src="{% static 'images/pips/pip_radiant.png' %}" alt='{{ summary.side }}'>
                {% else %}
                  <img src="{% static 'images/pips/pip_dire.png' %}" alt='{{ summary.side }}'>
                {% endif %}

              </td>
              <td>{% if summary.is_win %} <div class='glyphicon glyphicon-ok-circle win-glyph' title='Won' style='font-size:15px'></div>{% endif %}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock content %}

{% block extra_js %}
<script type="text/javascript">
  $(document).ready(function () {
    // @todo: store the pickban items in an array, so we know things like how many there are.
    var PICKBAN_LIMIT = {{ pickban_length }};
    var pickban_position = -1;

    // Set-up:
    $('.pickban-list li').hide();

    // Manual cycling:
    $('#pickban-forward').click(function () {
      if (pickban_position === PICKBAN_LIMIT - 1) {
        return;
      }
      $('.dire-pickban, .radiant-pickban').show();
      pickban_position++;
      $('[data-pborder=' + pickban_position + ']').fadeIn();
    });
    $('#pickban-backward').click(function () {
      if (pickban_position === -1) {
        return;
      }
      $('.dire-pickban, .radiant-pickban').show();
      $('[data-pborder=' + pickban_position + ']').fadeOut();
      pickban_position--;
    });
  });
</script>
<script type="text/javascript">
  $(document).ready(function(){

    if ({{ min_skill_length }}==0){
        $('div#abilities').toggle('fast');
    }

    $('#abilities-reveal').click(function () {
        $('div#abilities').toggle('fast');
    })

  })
</script>
<script type="text/javascript">
$(function(){
  var url = '{% url "rest-api:player-match-summary-list" %}?match_id={{match.steam_id}}';

  Promise.resolve($.ajax(url))
  .then(function(data){

    var destination = '#kill_dmg';
    var plot_data = [
      {
        key:'Kills vs Hero Damage',
        values:data.map(function(d){
          return {
            x:d.kills,
            y:d.hero_damage,
          }
        }),
      }
    ]
    window.Chartreuse.scatter(destination, plot_data, 'Kills', 'Hero Damage');


    var destination = '#xp_gold';
    var plot_data = [
      {
        key:'Gold Gain vs XP Gain',
        values:data.map(function(d){
          return {
            x:d.xp_per_min,
            y:d.gold_per_min,
          }
        }),
      }
    ];
    window.Chartreuse.scatter(destination, plot_data, 'XP per min', 'Gold per min');


    var destination = '#kill_death';
    var plot_data = [
      {
        key:'Kills vs Deaths',
        values:data.map(function(d){
          return {
            x:d.deaths,
            y:d.kills,
          }
        }),
      }
    ];
    window.Chartreuse.scatter(destination, plot_data, 'Deaths', 'Kills');

    var destination = '#lh_denies';
    var plot_data = [
      {
        key:'Last Hits vs Denies',
        values:data.map(function(d){
          return {
            x:d.last_hits,
            y:d.denies,
          }
        }),
      }
    ];
    window.Chartreuse.scatter(destination, plot_data, 'Last Hits', 'Denies');


    (function(){
      var destination = '#kda2';
      nv.addGraph(function(){
        var plot_data = [{
          key:'KDA2',
          values:data.map(function(d){
            return {
              label: d.hero.name,
              value: d.kda2
            }
          })
        }];
        chart = nv.models.classDiscreteBarChart(destination, plot_data);
      })
    })();

    (function(){
      var destination = '#last_hits';
      nv.addGraph(function(){
        var plot_data = [{
          key:'Last Hits',
          values:data.map(function(d){
            return {
              label: d.hero.name,
              value: d.last_hits
            }
          })
        }];
        chart = nv.models.classDiscreteBarChart(destination, plot_data);
      })
    })();


    (function(){
      var destination = '#tower_damage';
      nv.addGraph(function(){
        var plot_data = [{
          key:'KDA2',
          values:data.map(function(d){
            return {
              label: d.hero.name,
              value: d.tower_damage
            }
          })
        }];
        chart = nv.models.classDiscreteBarChart(destination, plot_data);
      })
    })();

    (function(){
      var destination = '#abilities';
      var plot_data = data.map(function(d){
        return {
          key: d.hero.name,
          values: d.skillbuild
        }
      });
      nv.addGraph(function(){
        chart = nv.models.lineChart()
          .x(function(d){return d.time})
          .y(function(d){return d.level})
        svg = window.make_svg(destination, 230);
        chart_data = svg.datum(plot_data);
        chart_data.transition().duration(500).call(chart);

      })
    })();



  })
})
</script>
{% endblock extra_js %}
