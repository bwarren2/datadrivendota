{% extends "matches/base.html" %}

{% load staticfiles player_extras %}

{% block title %}Match #{{ match.steam_id }}{% endblock title %}

{% block page_title %}Match #{{ match.steam_id }}
<small>  {{ match.game_mode.description }} {{ match.lobby_type.description }},
    {{ match.hms_duration }} @ {{ match.hms_start_time }}</small>
    {% if match.league.leaguedossier %}
      <br>
      <small>Tournament:
      {% if match.league.leaguedossier.tournament_url %}
        <a href="{{match.league.leaguedossier.tournament_url}}">{{match.league.leaguedossier.display_name}}</a>
      {% else %}
        {{match.league.leaguedossier.display_name}}
      {% endif %}</small>
    {% endif %}
    {% endblock page_title %}

{% block content %}

  {% include "matches/_match_cards.html" %}

    <div class='container'>
        <div class='row' id='buttons'>
            <h2>Animation (times approximate):</h2>
            <div class='col-md-1'>
                <button id='stop-animation' type="button" class="btn btn-primary btn-lg btn-block animation-button">Stop</button>
            </div>
            <div class='col-md-1'>
                <button id='start-animation' type="button" class="btn btn-primary btn-lg btn-block animation-button">Start</button>
            </div>
            <div class='col-md-1'>
                <button id='back-animation' type="button" class="btn btn-primary btn-lg btn-block animation-button">
                    <span  class="info glyphicon glyphicon-backward">
                </button>
            </div>
            <div class='col-md-1'>
                <button id='forward-animation' type="button" class="btn btn-primary btn-lg btn-block animation-button">
                    <span  class="info glyphicon glyphicon-forward">
                </button>
            </div>
            <div class='col-md-2'>
                <input style='margin-top:5px' id='time-display' class='form-control' type='text' placeholder='Replay Time' readonly>
            </div>

            <div class='col-md-4 col-md-offset-1' id='related-match'>
                <a href="{%url 'matches:match_detail' match_id=match.steam_id%}"><button id='start-animation' type="button" class="btn btn-primary btn-lg btn-block">Match Summary</button></a>

            </div>
        </div>
        <div class='row' >
            <div class='goofyspacer'>
                <div class='col-md-4' id='lh_level'>
                    {% comment %}
                    <h4>Hero Kills <span  class="info glyphicon glyphicon-info-sign" data-toggle="tooltip" title="" data-placement="right"></span></h4>
                    {% endcomment %}

                </div>
                <div class='col-md-4' id='kill_dmg'>
                </div>

                <div class='col-md-4' id='death_dmg'>
                </div>
            </div>
        </div>
        <div class='row' id='hero-charts'>

            <div class='col-md-4' id='minimap'>
            </div>
            <div class='col-md-4'>
            </div>
            <div class='col-md-4'>
            </div>

        </div>
        <div class='row'>
            <div class='col-md-6 col-md-offset-3' id='note'>
                <p>Note: This is alpha tech.  There are some known issues, but the gist is here.</p>
            </div>
        </div>

    </div>{% endblock content %}

{% block extra_js %}
<script type="text/javascript">

var timeline
var heroes
$(function(){

    // Config
    var tick_idx = 0;
    var interval_duration = 50;
    var hero_json = {{hero_json|safe}}

    // Cosmetics
    $('.chart-pip').remove()
    $('.cast-player-image').remove()
    var div = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

    //Utility
    function updateTimer(d){
        $('#time-display').val(String((d-d%60)/60)+':'+String(d%60))
    }
    function loggingu(txt){
        console.log(txt)
    }
    function sortNumber(a,b) {
        return a - b;
    }
    function between(x, min, max) {
        return x >= min && x <= max;
    }
    function slice_timeline(timeline_segment){
        return_ary = $.map(
            timeline_segment,
            function(value, index) {
                if(between(index,0,10)){
                    return [value];
                }
            })
        return return_ary
    }

    // Charting!
    function healthBars(heroes, timeslice){
        var health_bar_height = 5
        loggingu('In health bars.')

        $.each(heroes, function(idx, val){
            var selector = '.'+val['hero_name']+'_slot'
            var width = $(selector).width()

            var svg = d3.select(selector).insert("svg", 'img')
            .attr("width", width)
            .attr("height", 2*health_bar_height)
            .attr("class", 'lifebar')

            var mbar = svg.append("rect")
            .attr("x", 0)
            .attr("y", health_bar_height)
            .attr("width", width)
            .attr("height", health_bar_height)
            .attr("class", val['hero_name']+' mana-bar');

            var hbar = svg.append("rect")
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", width)
            .attr("height", health_bar_height)
            .attr("class", val['hero_name']+' health-bar');

            // Listen for the update
            $(document).on('update', function(e, snapshot){
                var health_width = width*snapshot[idx]['health']/snapshot[idx]['max_health']
                hbar.transition()
                    .duration(interval_duration)
                    .attr('width', health_width)
                if(health_width === 0){}
                mbar.attr(
                    'width',
                    width*snapshot[idx]['mana']/snapshot[idx]['max_mana']
                )
            })

        })

    }


    function miniMap(heroes, timeslice){
        loggingu('In minimap mode.')

        var selector = 'div#minimap'
        var width = $(selector).width()
        var height = width
        d3.select(selector).style('position', 'relative')
        var svg = d3.select(selector)
            .append('svg')
            .attr('class', 'testchart')
            .attr('width', width)
            .attr('height', height)

        var defs = svg.append('svg:defs');

        defs.append('svg:pattern')
            .attr('id', 'tile-ww')
            .attr('patternUnits', 'userSpaceOnUse')
            .attr('width', width)
            .attr('height', height)
            .append('svg:image')
            .attr('xlink:href', '/assets/images/minimap.png')
            .attr('x', 0)
            .attr('y', 0)
            .attr('width', width)
            .attr('height', height)

        svg.append("rect")
           .attr("fill", "url(#tile-ww)")
           .attr('width', width)
           .attr('height', height)
           .attr('x', 0)
           .attr('y', 0)

        $.each(timeslice, function(idx, val){

            var icon_class = 'd2mh '+ heroes[idx]['hero_name']
            var hero_icon = d3.select(selector).insert("i")
               .attr('class', icon_class)
               .style('position', 'absolute')
               .attr('width', 32)
               .attr('height', 32)
               .style('top', val.y+'px')
               .style('left', val.x+'px')

            // Listen for the update
            $(document).on('update', function(e, snapshot){
                icon_class = '.d2mh.'+ heroes[idx]['hero_name']
                toppx = (300-(snapshot[idx].y/minmax['y']['max'])*300)+'px'
                leftpx = (300*(snapshot[idx].x/minmax['x']['max']))+'px'
                d3.select(icon_class).transition()
                    .style('top', toppx)
                    .style('left', leftpx)
            })

        })

    }



    function killDmg(heroes, timeslice, minmax){
        loggingu('In Kill Dmg.')
        selector = 'div#kill_dmg'
        var width = $(selector).width()
        var height = width // Mmm, squares
        var params = {'width': width, 'height': height}
        var margin = {top: 15, right: 15, bottom: 25, left: 60},
            width = params.width - margin.right - margin.left,
            height = params.height - margin.top - margin.bottom;


        x = d3.scale.linear()
            .domain([0, Math.min(minmax['calc_kills']['max'], 200)])
            .range(
                [0, width]
            )
        y = d3.scale.linear()
            .domain([
                    minmax['hero_damage_dealt']['min'],
                    minmax['hero_damage_dealt']['max']
                ])
            .range(
                [height, 0]
            )

        svg = d3.select(selector).insert('svg')
            .attr('class', 'kill_dmg')
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            // .style("margin-left", -margin.left + "px")
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


        xAxis = svg.append('g').attr('class', 'x axis')
            .attr('transform', 'translate(0,'+height+')')
            .call(d3.svg.axis().scale(x).orient("bottom"))

        yAxis = svg.append('g').attr('class', 'y axis')
            .attr('transform', 'translate(0,0)')
            .call(y.axis = d3.svg.axis().scale(y).orient('left'))

        svg.selectAll('circle').data(timeslice)
            .enter().append("circle")
            .attr("cx", function(d) {
                 return x(d.calc_kills);
            })
            .attr("cy", function(d) {
                 return y(d.hero_damage_dealt);
            })
            .attr("class", function(d) {
                 return heroes[d.hero_idx]['name'];
            })
            .attr("r", 5);

            // Listen for the update
            $(document).on('update', function(e, timeslice){
                d3.selectAll('circle').data(timeslice)
                .transition()
                .duration(interval_duration)
                .attr("cx", function(d) {
                   return x(d.calc_kills);
                })
                .attr("cy", function(d) {
                     return y(d[hero_damage_dealt]);
                })
            })
    }

    function updatingScatter(heroes, timeslice, minmax, x_var, y_var, target){
        loggingu('Updating '+target)
        var selector = target
        var width = $(selector).width()
        var height = width // Mmm, squares
        var params = {'width': width, 'height': height}
        var margin = {top: 15, right: 15, bottom: 25, left: 60},
            width = params.width - margin.right - margin.left,
            height = params.height - margin.top - margin.bottom;


        var x = d3.scale.linear()
            .domain([
                    minmax[x_var]['min'],
                    minmax[x_var]['max']
                ])
            .range(
                [0, width]
            )
        var y = d3.scale.linear()
            .domain([
                    minmax[y_var]['min'],
                    minmax[y_var]['max']
                ])
            .range(
                [height, 0]
            )

        var svg = d3.select(selector).insert('svg')
            // .attr('class', 'kill_dmg')
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            // .style("margin-left", -margin.left + "px")
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


        var xAxis = svg.append('g').attr('class', 'x axis')
            .attr('transform', 'translate(0,'+height+')')
            .call(d3.svg.axis().scale(x).orient("bottom"))

        var yAxis = svg.append('g').attr('class', 'y axis')
            .attr('transform', 'translate(0,0)')
            .call(y.axis = d3.svg.axis().scale(y).orient('left'))

        svg.selectAll(selector +' circle').data(timeslice)
            .enter().append("circle")
            .attr("cx", function(d) {
                 return x(d[x_var]);
            })
            .attr("cy", function(d) {
                 return y(d[y_var]);
            })
            .attr("class", function(d) {
                 return heroes[d.hero_idx]['name'];
            })
            .attr("r", 5);

            // Listen for the update
            $(document).on('update', function(e, timeslice){
                d3.selectAll(selector+' circle').data(timeslice)
                .transition()
                .duration(interval_duration)
                .attr("cx", function(d) {
                   return x(d[x_var]);
                })
                .attr("cy", function(d) {
                     return y(d[y_var]);
                })
            })
    }


    function setUp(heroes, timeline){
        loggingu('Setting up.')
        healthBars(heroes, timeline)
        // killDmg(heroes, timeline, minmax)
        miniMap(heroes, timeline)
        updatingScatter(
            heroes, timeline, minmax,
            'calc_kills', 'hero_damage_dealt', 'div#kill_dmg'
        )
        updatingScatter(
            heroes, timeline, minmax,
            'deaths', 'hero_damage_taken', 'div#death_dmg'
        )
        updatingScatter(
            heroes, timeline, minmax,
            'level', 'lh', 'div#lh_level'
        )
    }


    // Animation Controls
    $('#stop-animation').toggle()
    $('#start-animation').click(function(){
        $('#start-animation').toggle();
        $('#stop-animation').toggle();
        $('#back-animation').toggle();
        $('#forward-animation').toggle();
    });
    $('#stop-animation').click(function(){
        $('#start-animation').toggle();
        $('#stop-animation').toggle();
        $('#back-animation').toggle();
        $('#forward-animation').toggle();
    });

    var url = '{% static timeline %}';
    var chats;
    var hero_creeps = $.getJSON(url, function(result){

        // Wir mussen sie data machen
        timeline = result['timeline']
        heroes = result['heroes']
        chats = result['chats']
        minmax = result['minmax']
        $.each(heroes, function(i, v){
            heroes[i]['hero_name'] = hero_json[String(heroes[i]['id'])]
        })
        ints = Object.keys(timeline)

        var numArray = []
        $.each(ints, function(i, v){
            numArray.push(parseInt(v))
        })
        numArray.sort(sortNumber);

        function updateTimer(state){
            $('#time-display').val(state['time'])
        }

        // Prep the ticker
        var make_metronome = function(numArray, timeline){
            function new_index(adder){

                // GFD, javascript.  You're drunk.
                fakemod = function(n, modulus) {
                    return ((n%modulus)+modulus)%modulus;
                }
                tick_idx = fakemod((tick_idx+adder),numArray.length)
            }
            var myfun = function(change){
                new_index(change)

                // Take the hero data for that tick
                slice = slice_timeline(timeline[numArray[tick_idx]])
                $(document).trigger('update', [slice])
                updateTimer(timeline[numArray[tick_idx]])

            }
            return myfun;
        }
        metronome = make_metronome(numArray, timeline)
        bindHandlers(metronome)

        // Get the min tick
        data = []
        $.each(Object.keys(timeline), function(idx, val){
            data.push(parseInt(val));
        })
        tick = Math.min.apply(null, data)

        slice = slice_timeline(timeline[tick])
        // Set up graphics!
        updateTimer(timeline[tick])
        setUp(heroes, slice, minmax);
    });

    // Handling Handlers
    function bindHandlers(broadcast){
        var myhandle
        var play = function(){
            broadcast(1)
        }
        var start = function(){
            myhandle = setInterval(play, interval_duration)
        }

        var stop = function (){
            clearInterval(myhandle)
        }

        $('#start-animation').click(function(){
            start();
        })

        $('#stop-animation').click(function(){
            stop();
        })


        $('#back-animation').click(function(){
            broadcast(-1);
        });
        $('#forward-animation').click(function(){
            broadcast(1);
        });
    }
})
</script>

{% endblock extra_js %}

{% block extra_css %}
    <style type="text/css">
    {% for key, value in css_color_dict.iteritems %}
        .{{key}} {
            fill: {{value}};
        }
    {% endfor %}
    {% for key, value in slot_dict.iteritems %}
        .player-slot-{{key}} {
             box-shadow: 0 0 25.5px {{value}};
        }
    {% endfor %}
    path{
        fill: none;
    }
    .animation-button{
        height:45px;
    }
    circle{
        stroke-width:2;
        /*stroke-fill:#000000;*/
        stroke: #000000;
        r: 2;
    }
    .health-bar{
        fill: #84F721;
    }
    .mana-bar{
        fill: #507AEF;
    }
    img.desaturate{
        filter: grayscale(100%);
    }
    div.goofyspacer{
        margin-top:10px
    }
    </style>
{% endblock extra_css %}

